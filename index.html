<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>PPS AI Chat</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="favicon.png">

  <!-- Markdown renderer + Sanitizer -->
  <script src="https://cdn.jsdelivr.net/npm/marked@12/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.9/dist/purify.min.js"></script>

  <style>
    :root{
      --bg:#f3f4f6; --brand:#003366; --brand-2:#0055aa; --text:#0f172a; --muted:#64748b;
      --bubble-user:#d1e7ff; --bubble-bot:#fff; --bubble-border:#e2e8f0;
      --radius:12px; --footer-h:64px;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0}
    body{
      background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;
      display:flex; justify-content:center; align-items:stretch;
      min-height:100dvh;
    }
    .hidden{display:none!important}

    /* Login */
    .login-wrapper{
      width:100%; max-width:400px; background:#fff; padding:32px; border-radius:var(--radius);
      box-shadow:0 4px 14px rgba(0,0,0,.08); text-align:center; margin:16px;
    }
    .login-wrapper h2{margin-bottom:16px}
    .login-wrapper input{
      width:100%; padding:10px 12px; margin-bottom:8px; border:1px solid var(--bubble-border); border-radius:var(--radius)
    }
    .login-wrapper small{display:block; color:var(--muted); font-size:12px; margin-bottom:12px}
    .login-wrapper button{
      width:100%; padding:10px 14px; border-radius:var(--radius); border:1px solid var(--brand);
      background:var(--brand); color:#fff; cursor:pointer
    }
    .login-wrapper button:hover{background:var(--brand-2); border-color:var(--brand-2)}

    /* Chat wrapper */
    .chat-wrapper{
      width:100%; max-width:920px; height:100dvh;
      background:#fff; border:1px solid var(--bubble-border); border-radius:var(--radius);
      display:flex; flex-direction:column; box-shadow:0 4px 14px rgba(0,0,0,.08);
      overflow:hidden;
    }
    header{
      position:sticky; top:0; z-index:5;
      display:flex; justify-content:space-between; align-items:center;
      padding:8px 12px; border-bottom:1px solid var(--bubble-border); background:#fff;
    }
    header .title{ text-align:center; flex:1 }
    /* Logo responsive: min 36px - max 72px */
    header img{
      height:clamp(36px, 6vw, 72px);
      max-height:clamp(36px, 6vw, 72px);
      width:auto; object-fit:contain; display:block; margin:0 auto 4px
    }
    header h1{ margin:0; font-size:20px }
    /* M√¥ t·∫£ = 16px (b·∫±ng #prompt) */
    header p{ margin:4px 0 0; font-size:16px; color:#555 }
    header button.signout{
      padding:6px 12px; border-radius:999px; border:1px solid var(--brand); background:var(--brand); color:#fff; cursor:pointer; font-size:13px
    }
    header button.signout:hover{background:var(--brand-2); border-color:var(--brand-2)}

    #chat{
      flex:1; overflow-y:auto; padding:12px 16px; display:flex; flex-direction:column; gap:12px;
      scroll-behavior:smooth; background:#fff;
      padding-bottom:calc(var(--footer-h) + env(safe-area-inset-bottom, 0px) + 12px);
    }
    #chat::-webkit-scrollbar{width:6px}
    #chat::-webkit-scrollbar-thumb{background:rgba(0,0,0,.2); border-radius:4px}
    #chat::-webkit-scrollbar-thumb:hover{background:rgba(0,0,0,.35)}

    .msg{ max-width:75%; padding:10px 14px; border-radius:var(--radius); line-height:1.5; word-wrap:break-word; white-space:normal;
          animation:fadeIn .18s ease; display:flex; align-items:flex-start; gap:10px }
    .msg.assistant{ align-self:flex-start; background:var(--bubble-bot); border:1px solid var(--bubble-border) }
    .msg.user{ align-self:flex-end; background:var(--bubble-user); justify-content:flex-end }
    .avatar{ width:28px; height:28px; border-radius:50%; flex-shrink:0 }
    .content{ width:100% }
    .content a{ color:#0ea5e9; text-decoration:underline }
    .content img{ max-width:100%; height:auto; border-radius:8px; border:1px solid var(--bubble-border); margin:8px 0 }
    .content table{ border-collapse:collapse; width:100%; margin:8px 0 }
    .content th,.content td{ border:1px solid var(--bubble-border); padding:6px 8px; text-align:left }
    .content code{ font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace }
    .content pre{ background:#f8fafc; border:1px solid var(--bubble-border); border-radius:8px; padding:10px; overflow:auto }

    @keyframes fadeIn{ from{opacity:.0; transform:translateY(2px)} to{opacity:1; transform:translateY(0)} }

    footer{
      position:sticky; bottom:0; z-index:5;
      border-top:1px solid var(--bubble-border); background:#fff;
      padding:8px 12px calc(8px + env(safe-area-inset-bottom, 0px));
    }
    .footer-inner{ display:flex; gap:8px }
    #prompt{
      flex:1; padding:12px 12px; border:1px solid var(--bubble-border); border-radius:999px; outline:none; font-size:16px
    }
    button{ padding:12px 16px; border-radius:999px; border:1px solid var(--brand); background:var(--brand); color:#fff; cursor:pointer; font-size:15px }
    button:hover{ background:var(--brand-2); border-color:var(--brand-2) }
    .typing{ font-style:italic; color:var(--muted) }

    /* N√∫t m≈©i t√™n cu·ªôn v·ªÅ cu·ªëi (SVG, n·ªÅn tr·∫Øng ‚Äì m≈©i t√™n ƒëen, vi·ªÅn nh·∫π) */
    #scrollBtn{
      position:fixed; bottom:88px; left:50%; transform:translateX(-50%);
      background:#fff; color:#000; border:1px solid #e5e7eb;
      border-radius:50%; width:48px; height:48px; cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,.15);
      display:flex; align-items:center; justify-content:center;
      opacity:0; visibility:hidden; transition:opacity .3s ease, visibility .3s ease;
      z-index:10;
    }
    #scrollBtn svg{ width:22px; height:22px; display:block }
    #scrollBtn.show{ opacity:1; visibility:visible }

    @media (max-width:600px){
      .chat-wrapper{ max-width:100%; height:100dvh; border-radius:0 }
      header h1{ font-size:18px }
      header img{ height:36px; max-height:36px }
    }
  </style>
</head>
<body>

  <!-- Login -->
  <div id="login" class="login-wrapper">
    <h2>üîë Please Sign in</h2>
    <input id="accessInput" type="password" placeholder="Enter Access Code" />
    <small>Please enter the Access code provided by the admin.</small>
    <button id="loginBtn">Enter</button>
    <p id="loginMsg" style="color:red; display:none; margin-top:8px;">Invalid Access Code</p>
  </div>

  <!-- Chat UI -->
  <div id="chatUI" class="chat-wrapper hidden">
    <header>
      <div class="title">
        <img src="logo.png" alt="PPS Logo">
        <h1>Hi there! üëã</h1>
        <p>I am the AI Agent of PPS, here to support you 24/7</p>
      </div>
      <button class="signout" id="signoutBtn">Sign out</button>
    </header>

    <div id="chat"></div>

    <!-- N√∫t m≈©i t√™n SVG chevron-down ki·ªÉu ChatGPT -->
    <button id="scrollBtn" aria-label="Scroll to bottom" title="Scroll to bottom">
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>

    <footer id="appFooter">
      <div class="footer-inner">
        <input id="prompt" placeholder="Type to search, analyze, or request..." />
        <button id="sendBtn">Send</button>
      </div>
    </footer>
  </div>

<script>
/* ===== Footer height & mobile keyboard ===== */
(function(){
  const footer = document.getElementById('appFooter');
  const chat = document.getElementById('chat');
  function applyFooterHeight(){
    const h = footer?.offsetHeight || 64;
    document.documentElement.style.setProperty('--footer-h', h + 'px');
  }
  applyFooterHeight();
  window.addEventListener('resize', applyFooterHeight);
  if (footer && 'ResizeObserver' in window) new ResizeObserver(applyFooterHeight).observe(footer);

  if (window.visualViewport) {
    visualViewport.addEventListener('resize', () => {
      const wrap = document.querySelector('.chat-wrapper');
      if (wrap) wrap.style.height = visualViewport.height + 'px';
      chat.scrollTop = chat.scrollHeight;
    });
  }
  const input = document.getElementById('prompt');
  input.addEventListener('focus', () => { setTimeout(()=> chat.scrollTop = chat.scrollHeight, 50); });
})();

/* ===== Login via server + auto logout ===== */
const AUTO_LOGOUT_MS = 30 * 60 * 1000;
let inactivityTimer;

const accessEl = document.getElementById('accessInput');
const loginBtn  = document.getElementById('loginBtn');
const loginBox  = document.getElementById('login');
const chatBox   = document.getElementById('chatUI');
const loginMsg  = document.getElementById('loginMsg');
const signoutBtn= document.getElementById('signoutBtn');

function resetInactivityTimer(){
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(()=>{ alert("Session timed out."); signOut(); }, AUTO_LOGOUT_MS);
}
function initInactivityListeners(){
  ["click","keydown","mousemove","scroll","touchstart"].forEach(ev=>{
    document.addEventListener(ev, resetInactivityTimer, {passive:true});
  });
  resetInactivityTimer();
}

async function checkAccess(){
  const val = accessEl.value.trim();
  if (!val) { loginMsg.textContent='Please enter the Access code'; loginMsg.style.display='block'; return; }

  loginBtn.disabled = true;
  const oldLabel = loginBtn.textContent;
  loginBtn.textContent = 'ƒêang ki·ªÉm tra...';
  loginMsg.style.display='none';

  try{
    const res = await fetch("/api/login",{
      method:"POST",
      headers:{ "content-type":"application/json" },
      body:JSON.stringify({ code: val })
    });
    if(res.ok){
      loginBox.classList.add('hidden');
      chatBox.classList.remove('hidden');
      initInactivityListeners();
      accessEl.value='';
    }else{
      let reason='Invalid Access Code';
      try{ const j=await res.json(); if (j?.error) reason=j.error; }catch{}
      loginMsg.textContent = reason;
      loginMsg.style.display = 'block';
    }
  }catch(e){
    loginMsg.textContent = 'Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c /api/login.';
    loginMsg.style.display = 'block';
  }finally{
    loginBtn.disabled = false;
    loginBtn.textContent = oldLabel;
  }
}

/* S·ª≠a Enter + click */
loginBtn.addEventListener('click', checkAccess);
accessEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); checkAccess(); } });

async function signOut(){
  try{ await fetch("/api/logout",{ method:"POST" }); }catch{}
  chatBox.classList.add('hidden');
  loginBox.classList.remove('hidden');
  clearTimeout(inactivityTimer);
  localStorage.removeItem('ppsai_session_id');
  localStorage.removeItem('ppsai_messages');
  const chatEl = document.getElementById('chat');
  if (chatEl) chatEl.innerHTML='';
}
signoutBtn.addEventListener('click', signOut);

/* T·ª± m·ªü chat n·∫øu c√≥ phi√™n */
(async () => {
  const r = await fetch("/api/session").catch(()=>null);
  if (r && r.ok) {
    loginBox.classList.add('hidden');
    chatBox.classList.remove('hidden');
    initInactivityListeners();
  }
})();
</script>

<script>
/* ===== Chat logic (proxy qua /api/chat) ===== */
const chatEl=document.getElementById('chat');
const inputEl=document.getElementById('prompt');
const btnEl=document.getElementById('sendBtn');

const SESSION_KEY='ppsai_session_id';
let sessionId=localStorage.getItem(SESSION_KEY);
if(!sessionId){
  sessionId=(crypto&&crypto.randomUUID)?crypto.randomUUID():Date.now().toString();
  localStorage.setItem(SESSION_KEY,sessionId);
}

/* L·ªãch s·ª≠ c√≥ TTL & gi·ªõi h·∫°n */
const MSGS_KEY='ppsai_messages';
const HISTORY_TTL_DAYS=30, HISTORY_MAX_ITEMS=200, HISTORY_MAX_BYTES=800_000;

function loadMessages(){ try{return JSON.parse(localStorage.getItem(MSGS_KEY)||'[]');}catch{return[]} }
function saveMessages(arr){
  const now=Date.now(), ttlMs=HISTORY_TTL_DAYS*24*60*60*1000;
  let pruned=arr.filter(m=>!m.ts||(now-m.ts)<=ttlMs);
  if(pruned.length>HISTORY_MAX_ITEMS) pruned=pruned.slice(pruned.length-HISTORY_MAX_ITEMS);
  let json=JSON.stringify(pruned);
  while(json.length>HISTORY_MAX_BYTES&&pruned.length>1){ pruned.shift(); json=JSON.stringify(pruned); }
  localStorage.setItem(MSGS_KEY,json);
}
let messages=loadMessages(); renderHistory(messages);

btnEl.addEventListener('click',onSend);
inputEl.addEventListener('keydown',e=>{ if(e.key==='Enter') onSend(); });

/* M·ªü link trong tab m·ªõi */
chatEl.addEventListener('click',(e)=>{
  const a=e.target.closest('a'); if(!a) return;
  const href=a.getAttribute('href'); if(!href || href.startsWith('#')) return;
  e.preventDefault(); a.setAttribute('rel','noopener'); a.setAttribute('target','_blank');
  try{ window.open(a.href,'_blank','noopener,noreferrer'); }catch{ a.click(); }
});

function onSend(){
  const text=inputEl.value.trim(); if(!text) return;
  appendBubble(text,'user');
  messages.push({ role:'user', content:text, ts: Date.now() }); saveMessages(messages);

  inputEl.value=''; typing(true);
  sendToWebhook(sessionId,text).then(({content,image_url})=>{
    typing(false);
    appendBubble(content||'(kh√¥ng c√≥ n·ªôi dung)','assistant',image_url);
    messages.push({ role:'assistant', content:content||'', image_url:image_url||null, ts: Date.now() });
    saveMessages(messages);
  }).catch(err=>{
    typing(false);
    const msg=`Error: Failed to connect - ${err}`;
    appendBubble(msg,'assistant');
    messages.push({ role:'assistant', content:msg, image_url:null, ts: Date.now() });
    saveMessages(messages);
  });
}

function typing(show){
  let t=document.getElementById('typing');
  if(show && !t){
    t=document.createElement('div'); t.id='typing'; t.className='msg assistant typing';
    const av=document.createElement('img'); av.src="assistant_icon_256.png"; av.alt="ü§ñ"; av.className="avatar";
    av.onerror=()=>{ av.replaceWith(document.createTextNode("ü§ñ")); };
    t.appendChild(av);
    const span=document.createElement('div'); span.className='content'; span.textContent='Thinking...';
    t.appendChild(span);
    chatEl.appendChild(t); chatEl.scrollTop=chatEl.scrollHeight;
  } else if(!show && t){ t.remove(); }
}

/* Markdown render */
marked.setOptions({ gfm:true, breaks:true, headerIds:false, mangle:false });
function renderMarkdown(md){
  let html = marked.parse(md || '');
  html = html.replace(/<a /g, '<a target="_blank" rel="noopener" ');
  return DOMPurify.sanitize(html);
}

function appendBubble(text,role='assistant',imageUrl=null){
  const d=document.createElement('div');
  d.className='msg '+(role==='user'?'user':'assistant');

  if(role==='assistant'){
    const av=document.createElement('img'); av.src="assistant_icon_256.png"; av.alt="ü§ñ"; av.className="avatar";
    av.onerror=()=>{ av.replaceWith(document.createTextNode("ü§ñ")); };
    d.appendChild(av);
  }

  const content=document.createElement('div');
  content.className='content';
  content.innerHTML = renderMarkdown(text || '');
  d.appendChild(content);
  chatEl.appendChild(d);

  if(imageUrl){
    const w=document.createElement('div');
    w.className='content';
    w.innerHTML=`<a href="${encodeURI(imageUrl)}" target="_blank" rel="noopener">
      <img src="${encodeURI(imageUrl)}" alt="Image from AI">
    </a>`;
    chatEl.appendChild(w);
  }

  chatEl.scrollTop=chatEl.scrollHeight;
}

function renderHistory(arr){
  chatEl.innerHTML='';
  const sorted = [...arr].sort((a,b)=>(a.ts||0)-(b.ts||0));
  sorted.forEach(m=>appendBubble(m.content, m.role, m.image_url));
}

async function sendToWebhook(sessionId, message){
  const headers={'Content-Type':'application/json'};
  const res=await fetch("/api/chat",{
    method:'POST', headers, body:JSON.stringify({ sessionId, chatInput: message })
  });
  if(!res.ok){ const t=await res.text().catch(()=> ''); throw new Error(`${res.status} ${t.slice(0,200)}`); }
  const data=await res.json();
  let content=null, image_url=null;
  if(Array.isArray(data)){ const f=data[0]||{}; content=f.content||f.output; image_url=f.url; }
  else { content=data.content||data.output; image_url=data.url; }
  return { content, image_url };
}

/* === N√∫t m≈©i t√™n: hi·ªán khi ch∆∞a ·ªü ƒë√°y, ·∫©n khi ch·∫°m ƒë√°y === */
(function(){
  const chatBox = document.getElementById('chat');
  const scrollBtn = document.getElementById('scrollBtn');

  function toggleBtn(){
    const threshold = 200; // px c√°ch ƒë√°y
    if (chatBox.scrollHeight - chatBox.scrollTop > chatBox.clientHeight + threshold) {
      scrollBtn.classList.add('show');
    } else {
      scrollBtn.classList.remove('show');
    }
  }

  chatBox.addEventListener('scroll', toggleBtn);
  scrollBtn.addEventListener('click', () => {
    chatBox.scrollTop = chatBox.scrollHeight;
  });

  // set tr·∫°ng th√°i l√∫c load
  toggleBtn();
})();
</script>
</body>
</html>
