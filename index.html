<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>PPS AI Chat</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="favicon.png">

  <!-- Markdown renderer + Sanitizer -->
  <script src="https://cdn.jsdelivr.net/npm/marked@12/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.9/dist/purify.min.js"></script>

  <style>
    :root{
      --bg:#f3f4f6; --brand:#003366; --brand-2:#0055aa; --text:#0f172a; --muted:#64748b;
      --bubble-user:#f1f5f9; --bubble-bot:#fff; --bubble-border:#e2e8f0;
      --radius:12px; --footer-h:64px;
      --ui-font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                 Roboto, "Helvetica Neue", Arial, sans-serif,
                 "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; -webkit-text-size-adjust:100%}
    body{
      background:var(--bg); color:var(--text); font-family:var(--ui-font);
      display:flex; justify-content:center; align-items:stretch;
      min-height:100svh; overflow-x:hidden;
    }
    input, textarea, button { font-family: var(--ui-font); }
    .hidden{display:none!important}

    /* Login */
    .login-wrapper{
      width:100%; max-width:400px; background:#fff; padding:32px; border-radius:var(--radius);
      box-shadow:0 4px 14px rgba(0,0,0,.08); text-align:center; margin:16px;
    }
    .login-wrapper h2{ margin-bottom:16px; font-size:clamp(18px,4.5vw,24px); line-height:1.2 }
    .login-wrapper input{
      width:100%; padding:12px 14px; margin-bottom:8px; border:1px solid var(--bubble-border); border-radius:var(--radius);
      font-size:16px; /* FIX: ngÄƒn iOS auto-zoom */
    }
    .login-wrapper small{display:block; color:var(--muted); font-size:12px; margin-bottom:12px}
    .login-wrapper button{
      width:100%; padding:12px 14px; border-radius:var(--radius);
      border:1px solid var(--brand); background:var(--brand); color:#fff; cursor:pointer; font-size:15px
    }
    .login-wrapper button:hover{background:var(--brand-2); border-color:var(--brand-2)}

    /* Chat wrapper */
    .chat-wrapper{
      width:100%; max-width:920px; height:100svh; 
      background:#fff; border:1px solid var(--bubble-border); border-radius:var(--radius);
      display:flex; flex-direction:column; box-shadow:0 4px 14px rgba(0,0,0,.08);
      overflow:hidden; contain:layout size style;
    }
    header{
      position:sticky; top:0; z-index:5;
      display:flex; justify-content:space-between; align-items:center;
      padding:8px 12px; border-bottom:1px solid var(--bubble-border); background:#fff;
    }
    header .title{ text-align:center; flex:1 }
    header img{ height:clamp(32px,6vw,64px); width:auto; object-fit:contain; display:block; margin:0 auto 4px }
    header h1{ margin:0; font-size:clamp(16px,4.5vw,20px); font-weight:700 }
    header p{ margin:4px 0 0; font-size:clamp(13px,3.8vw,16px); color:#555 }

    header .controls{ display:flex; gap:10px; align-items:center }
    .stream-toggle{ font-size:13px; color:#333; display:flex; align-items:center; gap:6px; user-select:none }
    .stream-toggle input{ width:16px; height:16px }

    header button.signout{
      padding:6px 12px; border-radius:999px; border:1px solid var(--brand); background:var(--brand); color:#fff; cursor:pointer; font-size:13px
    }
    header button.signout:hover{background:var(--brand-2); border-color:var(--brand-2)}

    #chat{
      flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch;
      padding:12px 16px; display:flex; flex-direction:column; gap:12px;
      scroll-behavior:smooth; background:#fff;
      padding-bottom:calc(var(--footer-h) + env(safe-area-inset-bottom,0px) + 12px);
      overscroll-behavior:contain;
    }
    #chat::-webkit-scrollbar{width:6px}
    #chat::-webkit-scrollbar-thumb{background:rgba(0,0,0,.2); border-radius:4px}

    .msg{ max-width:75%; padding:10px 14px; border-radius:var(--radius); line-height:1.6;
          word-wrap:break-word; white-space:normal; animation:fadeIn .18s ease;
          display:flex; align-items:flex-start; gap:10px }
    .msg.assistant{ align-self:stretch; max-width:100%; background:var(--bubble-bot) }
    .msg.user{ align-self:flex-end; background:var(--bubble-user); justify-content:flex-end }
    .avatar{ width:28px; height:28px; border-radius:50%; flex-shrink:0 }
    .content a{ color:#0ea5e9; text-decoration:underline }
    .content img{ max-width:100%; height:auto; border-radius:8px; border:1px solid var(--bubble-border); margin:8px 0 }
    .content table{ border-collapse:collapse; width:100%; margin:8px 0 }
    .content th,.content td{ border:1px solid var(--bubble-border); padding:6px 8px; text-align:left }

    @keyframes fadeIn{ from{opacity:.0; transform:translateY(2px)} to{opacity:1; transform:translateY(0)} }

    footer{
      position:fixed; left:50%; transform:translateX(-50%);
      width:min(920px, 100%); bottom:0; z-index:6;
      border-top:1px solid var(--bubble-border); background:#fff;
      padding:8px 12px calc(8px + env(safe-area-inset-bottom,0px));
    }
    .footer-inner{ display:flex; gap:8px; align-items:flex-end }
    #prompt{
      flex:1; padding:12px 12px; border:1px solid var(--bubble-border); border-radius:12px;
      outline:none; font-size:16px;
      resize:none; overflow-y:hidden; line-height:1.5; min-height:44px; max-height:40vh;
    }
    #sendBtn{ font-size:14px; height:44px; padding:0 16px; display:inline-flex; align-items:center; justify-content:center; flex:0 0 auto }
  </style>
</head>
<body>

  <!-- Login -->
  <div id="login" class="login-wrapper">
    <h2>ðŸ”‘ Please Sign in</h2>
    <input id="accessInput" type="password" placeholder="Enter Access Code" />
    <small>Please enter the Access code provided by the admin</small>
    <button id="loginBtn">Enter</button>
    <p id="loginMsg" style="color:red; display:none; margin-top:8px;">Invalid Access Code</p>
  </div>

  <!-- Chat UI -->
  <div id="chatUI" class="chat-wrapper hidden">
    <header>
      <div class="title">
        <img src="logo.png" alt="PPS Logo">
        <h1>Hi there! ðŸ‘‹</h1>
        <p>I am the AI Agent of PPS, here to support you 24/7</p>
      </div>
      <div class="controls">
        <label class="stream-toggle">
          <input type="checkbox" id="toggleStream"> Enable Streaming
        </label>
        <button class="signout" id="signoutBtn">Sign out</button>
      </div>
    </header>
    <div id="chat"></div>
    <footer id="appFooter">
      <div class="footer-inner">
        <textarea id="prompt" rows="1" placeholder="Type to search, analyze, or request..."></textarea>
        <button id="sendBtn">Send</button>
      </div>
    </footer>
  </div>

<script>
/* ===== Chat logic vá»›i Streaming sá»­a lá»—i JSON ===== */
const chatEl=document.getElementById('chat');
const inputEl=document.getElementById('prompt');
const btnEl=document.getElementById('sendBtn');

const toggleStreamEl=document.getElementById('toggleStream');
let useStreaming=toggleStreamEl.checked;
toggleStreamEl.addEventListener('change',()=>useStreaming=toggleStreamEl.checked);

function renderMarkdown(md){return DOMPurify.sanitize(marked.parse(md||''));}
function appendBubble(text,role='assistant'){const d=document.createElement('div');d.className='msg '+role;const c=document.createElement('div');c.className='content';c.innerHTML=renderMarkdown(text);d.appendChild(c);chatEl.appendChild(d);chatEl.scrollTop=chatEl.scrollHeight;return d;}

async function streamFromWebhook(sessionId,message,targetNode){
  const headers={'Content-Type':'application/json','Accept':'text/event-stream'};
  const payload=JSON.stringify({sessionId,chatInput:message});
  let res=await fetch("/api/chat/stream",{method:'POST',headers,body:payload});
  if(!res.ok||!res.body){return;}
  const reader=res.body.getReader();const decoder=new TextDecoder();let buffer='';let acc='';
  while(true){
    const {done,value}=await reader.read();if(done)break;
    buffer+=decoder.decode(value,{stream:true});
    let lines=buffer.split(/\r?\n/);buffer=lines.pop();
    for(const line of lines){
      const text=line.startsWith("data:")?line.slice(5).trim():line.trim();
      if(!text)continue;if(text==="[DONE]"){buffer='';break;}
      try{const obj=JSON.parse(text);if(obj.type==="item"&&obj.content)acc+=obj.content;}
      catch{}
    }
    targetNode.querySelector('.content').innerHTML=renderMarkdown(acc);
  }
  return acc;
}

btnEl.addEventListener('click',async()=>{
  const text=inputEl.value.trim();if(!text)return;
  appendBubble(text,'user');inputEl.value='';
  const node=appendBubble('','assistant');
  if(useStreaming){await streamFromWebhook("sess",text,node);}
});
</script>
</body>
</html>
